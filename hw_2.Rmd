---
title: "CSSS 512 HW 2"
author: "Chris Hess"
date: "April 19, 2018"
output: html_document
---

```{r setup, include=FALSE, echo=F, results='hide'}
#packages
library(tidyverse)
library(curl)
library(xts)
library(latex2exp)
library(stargazer)
library(forecast)
library(xtable)

#options
options(xtable.comment = FALSE)

#data from Chris's website
congress <- read_csv("./congress.csv")
```

## Problem 1 - U.S. House of Representatives

### Part a

```{r 1.a, warning = F}
#plot ts, ACF, PACF
#run ADF and PP tests
#demean by pre/post 1994 periods
#plot ts, ACF, PACF
#what effect does 1994 structural break have on ts?

#pull ts, every other year frequency 1963-2017
ts_house <- ts(congress$DemHouseMaj, 
               frequency = 1/2,
               start = 1963, end = 2017)

#plot as observed
autoplot(ts_house) +
  geom_hline(yintercept = 0, linetype = 3, color = "grey60") +
  geom_vline(xintercept = 1994, color = "Blue") +
  theme_minimal() +
  labs(title = "Democratic House Majority Time-series")

#observed ACF
ggAcf(ts_house) + #substantial autocorrelation but not quite geometric decline
  theme_minimal() +
  labs(title = "Democratic House Majority ACF")

#observed PACF
ggPacf(ts_house) + #AR(1), phi = .65 ish
  theme_minimal() +
  labs(title = "Democratic House Majority PACF")

#pre-1994 mean for ts
preMean <- congress %>% 
  filter(StartYear < 1994) %>% 
  summarize(mean = mean(DemHouseMaj)) %>% 
  pull(mean)

#post-1994 mean for ts
postMean <- congress %>% 
  filter(StartYear >= 1994) %>% 
  summarize(mean = mean(DemHouseMaj)) %>% 
  pull(mean)

#demean based on pre/post 1994 (i.e. 1-16th obs vs 17-28th obs)
ts_house[1:16] <- ts_house[1:16] - preMean 
ts_house[-1:-16] <- ts_house[-1:-16] - postMean

#demeaned ts - looks stationary now
autoplot(ts_house) +
  geom_hline(yintercept = 0, linetype = 3, color = "grey60") +
  geom_vline(xintercept = 1994, color = "Blue") +
  theme_minimal() +
  labs(title = "Democratic House Majority Time-series")

#demeaned ACF
ggAcf(ts_house) + #no autocorrelation
  theme_minimal() +
  labs(title = "Democratic House Majority ACF")

#demeaned PACF
ggPacf(ts_house) + #no need for lags
  theme_minimal() +
  labs(title = "Democratic House Majority PACF")
```

### Part b 

```{r 1.b}
#pull ts, every other year frequency 1963-2017
ts_house <- ts(congress$DemHouseMaj, 
               frequency = 1/2,
               start = 1963, end = 2017)

#create df of covariates
covar <- congress %>% select(PartisanMidterm, PartisanUnem, Coattails, Pre1994)

#function to provide sum stats that can be passed to xtable()
armaFit <- function(ts, order = c(0, 0, 0), seasonal.order = c(1, 0, 0), seasonal.period = NA, xdf = NULL){
  if(is.na(seasonal.period)){
    mod <- Arima(ts, order = order, xreg = xdf)
  } else{
    mod <- Arima(ts, order = order, seasonal = list(order = seasonal.order, period = seasonal.period), xreg = xdf)
  }
  lab.order <- paste0("(", order[1], ",", order[2], ",", order[3], ")")
  aic <- mod[['aic']]
  se_reg <- sqrt(mod[['sigma2']])
  coef <- mod[['coef']]
  coef <- coef[c((length(coef)-2), (length(coef)-1), length(coef))]
  se <- sqrt(diag(mod[['var.coef']]))
  se <- se[c((length(se)-2), (length(se)-1), length(se))]
  
  names(lab.order) <- "ARMA Model"
  names(aic) <- "AIC"
  names(se_reg) <- "Std. Err Regressi"
  
  oneline <- c(lab.order, aic, se_reg, coef)
  twoline <- c("", "", "", paste0("(", se, ")"))
  lines <- rbind(oneline, twoline)
  rownames(lines) <- NULL
  
  return(lines)
}

#AR(0) with covariates
ar0 <- armaFit(ts_house, order = c(0, 0, 0), xdf = covar)
coef_ar0 <- stargazer(arima(ts_house, order = c(0, 0, 0), xreg = covar))
```

```{r, results = "asis"}
xtable(ar0)

coef_ar0
```

### Part c

```{r 1.c, warning = F, message = F}
#AR(1)
ar1 <- armaFit(ts_house, order = c(1, 0, 0), xdf = covar)
tab.ar1 <- xtable(ar1)

#AR(2)
ar2 <- armaFit(ts_house, order = c(2, 0, 0), xdf = covar)
tab.ar2 <- xtable(ar2)

#MA(1)
ma1 <- armaFit(ts_house, order = c(0, 0, 1), xdf = covar)
tab.ma1 <- xtable(ma1)

#ARMA(1,1)
arma11 <- armaFit(ts_house, order = c(1, 0, 1), xdf = covar)
tab.arma11 <- xtable(arma11)

#bind the sum stat rows together
sums <- rbind(ar0, ar1, ar2, ma1, arma11)
coef_mods <- stargazer(arima(ts_house, order = c(0, 0, 0), xreg = covar),
                       arima(ts_house, order = c(1, 0, 0), xreg = covar),
                       arima(ts_house, order = c(2, 0, 0), xreg = covar),
                       arima(ts_house, order = c(0, 0, 1), xreg = covar),
                       arima(ts_house, order = c(1, 0, 1), xreg = covar))
```

```{r, results = "asis"}
xtable(sums)

coef_mods
```

### Part d

```{r 1.d}
f_ar0 <- function(x, h){forecast(Arima(x, order=c(0,0,0)), h=h)}
e_ar0 <- tsCV(ts_house, f_ar0, h = 3,
              window = 20)

f_ar1 <- function(x, h){forecast(Arima(x, order=c(1,0,0)), h=h)}
e_ar1 <- tsCV(ts_house, f_ar1, h = 3,
              window = 20)

f_ar2 <- function(x, h){forecast(Arima(x, order=c(2,0,0)), h=h)}
e_ar2 <- tsCV(ts_house, far2, h = 3,
              window = 20)

f_ma1 <- function(x, h){forecast(Arima(x, order=c(0,0,1)), h=h)}
e_ma1 <- tsCV(ts_house, f_ma1, h = 3,
              window = 20)

f_arma11 <- function(x, h){forecast(Arima(x, order=c(1,0,1)), h=h)}
e_arma11 <- tsCV(ts_house, f_arma11, h = 3,
              window = 20)
```


### Part e

```{r}
#selecting ARMA(1,1) as final model
arma11 <- Arima(ts_house, order = c(1, 0, 1), xreg = covar)

#counterfactual 1 - unemployment stays at 4.6% for all three elections
cf1 <- data.frame(
  "Pre1994" = rep(0, 3), #all forecasts are post1994
  "ParisanUnemp" = rep(4.6, 3),
  "PartisanMidterm" = c(-1, 0, 1),
  "Coattails" = c(0, 1, 0)
)
cf1

#forecast forward three periods based on cf1 X's
pred_cf1 <- predict(arma11, newxreg = cf1)

##counterfactual 2 - unemployment falls to 3.6% for all three elections
cf2 <- data.frame(
  "Pre1994" = rep(0, 3), #all forecasts are post1994
  "ParisanUnemp" = rep(3.6, 3),
  "PartisanMidterm" = c(-1, 0, 1),
  "Coattails" = c(0, 1, 0)
)
cf2

#forecast forward three periods based on cf2 X's
pred_cf2 <- predict(arma11, newxreg = cf2)

##counterfactual 2 - unemployment rises to 5.6% for all three elections
cf3 <- data.frame(
  "Pre1994" = rep(0, 3), #all forecasts are post1994
  "ParisanUnemp" = rep(5.6, 3),
  "PartisanMidterm" = c(-1, 0, 1),
  "Coattails" = c(0, 1, 0)
)
cf3

#forecast forward three periods based on cf2 X's
pred_cf3 <- predict(arma11, newxreg = cf3)

#construct tidy matrix for value, upper and lower
pred_vals <- rbind(pred_cf1$pred[1], pred_cf1$pred[1]+1.96*pred_cf1$se, pred_cf1$pred[1]-1.96*pred_cf1$se)
pred_vals <- data.frame(
  cf = c(rep("Scenario 1", 3), rep("Scenario 2", 3), rep("Scenario 3", 3)),
  time = rep(seq(1, 3), 3),
  values = c(pred_cf1$pred, pred_cf2$pred, pred_cf3$pred),
  upper = c(pred_cf1$pred[1]+1.96*pred_cf1$se,
            pred_cf1$pred[2]+1.96*pred_cf1$se,
            pred_cf1$pred[3]+1.96*pred_cf1$se,
            pred_cf2$pred[1]+1.96*pred_cf2$se,
            pred_cf2$pred[2]+1.96*pred_cf2$se,
            pred_cf2$pred[3]+1.96*pred_cf2$se,
            pred_cf3$pred[1]+1.96*pred_cf3$se,
            pred_cf3$pred[2]+1.96*pred_cf3$se,
            pred_cf3$pred[3]+1.96*pred_cf3$se),
  lower = c(pred_cf1$pred[1]-1.96*pred_cf1$se,
            pred_cf1$pred[2]-1.96*pred_cf1$se,
            pred_cf1$pred[3]-1.96*pred_cf1$se,
            pred_cf2$pred[1]-1.96*pred_cf2$se,
            pred_cf2$pred[2]-1.96*pred_cf2$se,
            pred_cf2$pred[3]-1.96*pred_cf2$se,
            pred_cf3$pred[1]-1.96*pred_cf3$se,
            pred_cf3$pred[2]-1.96*pred_cf3$se,
            pred_cf3$pred[3]-1.96*pred_cf3$se))

ggplot(pred_vals, aes(x = time, y = values, ymin = lower, ymax = upper, group = cf, color = cf, fill = cf)) +
  geom_line() +
  geom_point() +
  geom_ribbon(color = NA, alpha = .25) +
  scale_x_continuous(breaks = c(1, 2, 3), labels = c("2019", "2021", "2023")) +
  xlab("\nStart Year of Congress") +
  ylab("Predicted House Dem Share\n") +
  labs(subtitle = "Shaded area denotes 95% predictive interval",
       fill = "Counterfactual",
       color = "Counterfactual") +
  theme_minimal()
```

## Problem 2 - U.S. Senate


### Part a

```{r 2.a, warning = F}
#plot ts, ACF, PACF
#run ADF and PP tests
#demean by pre/post 1994 periods
#plot ts, ACF, PACF
#what effect does 1994 structural break have on ts?

#pull ts, every other year frequency 1963-2017
ts_senate <- ts(congress$DemSenateMaj, 
               frequency = 1/2,
               start = 1963, end = 2017)

#plot as observed
autoplot(ts_senate) +
  geom_hline(yintercept = 0, linetype = 3, color = "grey60") +
  geom_vline(xintercept = 1994, color = "Blue") +
  theme_minimal() +
  labs(title = "Democratic Senate Majority Time-series")

#observed ACF
ggAcf(ts_senate) + #could be AR(1)
  theme_minimal() +
  labs(title = "Democratic Senate Majority ACF")

#observed PACF
ggPacf(ts_senate) + #AR(1), phi = .65 ish
  theme_minimal() +
  labs(title = "Democratic senate Majority PACF")

#pre-1994 mean for ts
preMean <- congress %>% 
  filter(StartYear < 1994) %>% 
  summarize(mean = mean(DemSenateMaj)) %>% 
  pull(mean)

#post-1994 mean for ts
postMean <- congress %>% 
  filter(StartYear >= 1994) %>% 
  summarize(mean = mean(DemSenateMaj)) %>% 
  pull(mean)

#demean based on pre/post 1994 (i.e. 1-16th obs vs 17-28th obs)
ts_senate[1:16] <- ts_senate[1:16] - preMean 
ts_senate[-1:-16] <- ts_senate[-1:-16] - postMean

#demeaned ts - looks stationary now
autoplot(ts_senate) +
  geom_hline(yintercept = 0, linetype = 3, color = "grey60") +
  geom_vline(xintercept = 1994, color = "Blue") +
  theme_minimal() +
  labs(title = "Democratic Senate Majority Time-series")

#demeaned ACF
ggAcf(ts_senate) + #still shows autocorrelation
  theme_minimal() +
  labs(title = "Democratic Senate Majority ACF")

#demeaned PACF
ggPacf(ts_senate) + #need an AR(1) with phi = .6 for this ts
  theme_minimal() +
  labs(title = "Democratic Senate Majority PACF")
```

### Part b 

```{r 1.b}
#pull ts, every other year frequency 1963-2017
ts_senate <- ts(congress$DemSenateMaj, 
               frequency = 1/2,
               start = 1963, end = 2017)

#create df of covariates
covar <- congress %>% select(PartisanMidterm, PartisanUnem, Coattails, Pre1994)

#AR(0) with covariates
ar0 <- armaFit(ts_senate, order = c(0, 0, 0), xdf = covar)

#AR(1)
ar1 <- armaFit(ts_senate, order = c(1, 0, 0), xdf = covar)
tab.ar1 <- xtable(ar1)

#AR(2)
ar2 <- armaFit(ts_senate, order = c(2, 0, 0), xdf = covar)
tab.ar2 <- xtable(ar2)

#MA(1)
ma1 <- armaFit(ts_senate, order = c(0, 0, 1), xdf = covar)
tab.ma1 <- xtable(ma1)

#ARMA(1,1)
arma11 <- armaFit(ts_senate, order = c(1, 0, 1), xdf = covar)
tab.arma11 <- xtable(arma11)

#bind the sum stat rows together
sums <- rbind(ar0, ar1, ar2, ma1, arma11)
coef_mods <- stargazer(arima(ts_senate, order = c(0, 0, 0), xreg = covar),
                       arima(ts_senate, order = c(1, 0, 0), xreg = covar),
                       arima(ts_senate, order = c(2, 0, 0), xreg = covar),
                       arima(ts_senate, order = c(0, 0, 1), xreg = covar),
                       arima(ts_senate, order = c(1, 0, 1), xreg = covar))
```

```{r, results = "asis"}
xtable(sums)

coef_mods
```

### Part c

```{r, warning = FALSE, message = FALSE}
ar1_seas1 <- armaFit(ts_senate, order = c(1, 0, 0), seasonal.order = c(1, 0, 0), seasonal.period = 3,
                xdf = covar)
summary(ar1_seas1)
stargazer(arima(ts_senate, order = c(1, 0, 0), seasonal = list(order = c(1, 0, 0), period = 3), xreg = covar))
```

